import {effectUtils, genericUtils, socketUtils} from '../../../utils.js';

async function use({workflow}) {
    let concentrationEffect = effectUtils.getConcentrationEffect(workflow.actor, workflow.item);
    let template = workflow.template;
    if (!template) {
        if (concentrationEffect) await genericUtils.remove(concentrationEffect);
        return;
    }
    await genericUtils.update(template, {
        flags: {
            'chris-premades': {
                template: {
                    name: workflow.item.name
                },
                rules: 'modern',
                castData: workflow.castData,
                macros: {
                    midi: {
                        actor: ['globeOfInvulnerabilityInvulnerable']
                    }
                }
            }
        }
    });
}
async function targeted({trigger: {token, castData}, workflow}) {
    if (workflow.item.type !== 'spell') return;
    let globeLevel = castData.castLevel;
    let spellLevel = workflowUtils.getCastLevel(workflow);
    if (spellLevel > (globeLevel - 1)) return;
    let newTargets = workflow.targets.difference(new Set([token]));
    await genericUtils.updateTargets(newTargets, socketUtils.firstOwner(workflow.actor));
    workflow.targets = newTargets;
}
export let globeOfInvulnerability = {
    name: 'Globe of Invulnerability',
    version: '1.2.29',
    rules: 'modern',
    midi: {
        item: [
            {
                pass: 'rollFinished',
                macro: use,
                priority: 50
            }
        ]
    }
};
export let globeOfInvulnerabilityInvulnerable = {
    name: 'Globe of Invulnerability: Invulnerable',
    version: globeOfInvulnerability.version,
    rules: globeOfInvulnerability.rules,
    midi: {
        actor: [
            {
                pass: 'targetPreambleComplete',
                macro: targeted,
                priority: 25
            }
        ]
    }
};